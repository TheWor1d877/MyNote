## 网络协议栈全景
- 硬件： 网卡
- 硬件驱动： 网卡驱动
- 数据链路层： mac地址，帧处理
- 网络层： IP协议处理（IPv4/v6）：路由、分片、重组，防火墙（iptables/nftables）、NAT、包过滤
- 传输层： TCP/UDP协议栈
- 套接字与接口层： （socket/bind/connect/send/recv），路复用：epoll/select底层支持
- 应用层: 用户态

## 数据表示
应用层： data
传输层： segment
网络层： package
数据链路层： frame

## 网络数据包的收发
#### 发送网络数据包
TCP: 应用层： send/write 
传输层申请skb，设备驱动层释放
网络层传输的时候可能拆成多个MSS，每一个都留在内存中一份副本，用于重发

UDP: 应用层： send to
没有发送缓冲区


#### 接受网络数据包
TCP：
应用层recv
设备驱动层申请skb，传输层释放
在 网络层做乱需重组，重复丢弃，窗口更新

UDP：
应用层recvfrom
没有接受缓冲区
无重排，流量控制

## sk_buff
一个描述网络数据包如何在内核中存放与主传递的结构体
![[Attachments/Pasted image 20251226111053.png]]
#### 发送方向
用户态基于socket library调用系统接口，传送数据到达socket kernel
内核态socket 层读取用户态数据，并按照应用层的协议类型，将数据发送到对应的传输层
传输层申请 skb 数据结构，并填充数据到skb，然后skb 会向下传送到网络层和链路层（链路层在内核对应网络设备层），继续添加 IP 和 MAC header到skb中
网络设备驱动skb 中获取到packet data 数据的虚拟地址，并映射出dma总线地址,将地址交给网卡，进行DMA读取然后发送数据

#### 接收方向
网卡接受到数据包之后借用pcle总线与dma将数据放入网卡驱动中
设备驱动收到数据包之后申请SKB，并将数据放入SKB 结构指向的数据空间
两种放入方式，一种是memcpy一种是零拷贝


#### skbuff的组成
![[Attachments/Pasted image 20251226114010.png]]
