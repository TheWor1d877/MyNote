## 连接与状态侦察
#### ss（替代老旧的 netstat）
- 查看所有监听中的端口（服务器视角
```bash
sudo ss -tulnp #查看所有监听中的端口(服务器视角)

ss -tan #查看所有已建立的连接（客户端视角）：
```

查看进程信息（找出谁在监听)
```bash
sudo ss -tulnp
```

按照状态过滤
```bash
# 查看所有处于TIME-WAIT状态的连接（连接关闭后的等待状态）
ss -tan state time-wait

# 查看所有ESTABLISHED（已建立）的连接
ss -tan state established

# 查看所有SYN-SENT（正在尝试连接）的连接 - 连接失败时常见
ss -tan state syn-sent
```

#### lsof（文件、网络、进程关联）
lsof (list open files) 更强大：在Linux中，“一切皆文件”，网络连接也是文件。
- 查看指定端口被谁占用（排障经典问题）
```bash
sudo lsof -i :22
```
- 查看指定进程打开的所有网络连接
```bash
# 先找出Chrome或Firefox的PID
pgrep chrome
# 使用pkill杀进程
pkill -9 -f chrome
# 假设PID是1234
sudo lsof -p 1234 -i
```
- 查看指定用户的所有网络活动：
```bash
sudo lsof -u your_username -i
```

-u 用户名
-i  大小写不敏感
-f 将整行当作进程名称
-p 查找pid

## 连通性与路由诊断
#### ping - 基础连通性测试
- 1. 持续ping，用于监控网络稳定性
```bash
ping -c 10 8.8.8.8 # 发送100个包后停止
```
- 输出：
```bash
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=3 ttl=109 time=202 ms
.....
--- 8.8.8.8 ping statistics ---
10 packets transmitted, 8 received, 20% packet loss, time 9090ms
rtt min/avg/max/mdev = 200.573/202.687/211.507/3.417 ms
```
ttl 最多 再多少跳就被抛弃
注意：网络丢包的破坏了远大于高延迟
- 2. 记录时间戳，用于分析延迟变化
```bash
  ping -c 10 -D 8.8.8.8
```
- 3. 设置间隔和包大小（模拟不同流量）
```bash
ping -c 20 -i 0.1 -s 1400 8.8.8.8  # 每0.1秒发送1400字节的包
```
#### traceroute/mtr 路由跟踪
traceroute 默认使用 UDP 包（不是 ICMP！），而不是 ping 用的那种 ICMP Echo。
发送一个 UDP 数据包 到一个高目的端口（比如 33434–33534，通常没人监听）、
每个中间路由器在 TTL 减到 0 时，会返回一个 ICMP Time Exceeded 消息（类型 11）
```bash
# 查看数据包经过的路由节点
traceroute google.com
```
- 输出
```bash
howardhe@ASUS-HE:~$ traceroute baidu.com
traceroute to baidu.com (111.63.65.247), 64 hops max
  1   100.87.0.1  41.473ms  13.133ms  7.684ms 
  2   61.178.252.149  27.664ms  23.102ms  16.658ms 
  3   *  *  * 
  4   *  *  * 
# 64 hops max 最多64跳
# 
```
## 网络层ip配置
#### ip 
- 网络接口信息
```bash
ip a
```
 重要区分：`<UP>` vs state UP
 前面是管理状态，后面是操作状态也就是真正的状态
  只有当两者都是 UP 时，接口才能真正通信。
`<BROADCAST,MULTICAST,UP,LOWER_UP>`
第一个up是该接口已经被管理员启动，第二个是底层链路已经激活
- 路由表信息
```bash
ip r # 
ip route get 8.8.8.8
```
- 查找一个ip地址的路由路线
```bash
ip route get 8.8.8.8
# 输出
8.8.8.8 via 100.87.0.1 dev wlp4s0 src 100.87.50.49 uid 1000 
    cache 
```
解释： 
- via： 下一跳是100.87.0.1
- dev: 数据包从无线网卡wlp4s0发出
p4: PCL bus number 4
s0: solt/device 0 on that bus
- src: 从哪里发出来，源ip地址是多少
- uid: 1000
- cache: 使用内核的路由缓存（route cache）



## 网络命令使用技巧
[[Linux/Linux命令/网络命令使用技巧|网络命令使用技巧]]