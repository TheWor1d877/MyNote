## 容量侦察（空间用了多少？）
#### df 磁盘空间宏观侦察
df (disk free) 查看文件系统的磁盘空间使用情况（每个挂载点用了多少）。
```bash
# 基础用法：人类可读格式
df -h

# 带文件系统类型
df -hT

# 只显示特定文件系统类型（如ext4、xfs）
df -hTt ext4
```

#### du - 微观空间分析（哪个目录/文件最大？）
```bash
# 查看当前目录总大小
du -sh

# 查看当前目录下所有子目录的大小，按大小排序!! 重要
du -sh * | sort -hr
```

## 性能侦察（磁盘快不快？）
#### iostat - 磁盘I/O性能侦察
```bash
# 1. 查看所有磁盘的实时I/O统计（每2秒刷新，共5次）
iostat -dx 2 5
```

#### iotop
`iotop` - 进程级I/O侦察（类似 `top`
查看**哪个进程在进行磁盘I/O**。
```bash
sudo iotop
```
- 按 **`o`**：只显示正在进行I/O的进程
- 按 **`r`**：反转排序顺序
- 按 **`p`**：只显示进程（不显示线程）

#### fio 专业的、功能强大的存储基准测试和压力测试工具
```bash
# 测试随机读性能
fio --name=randread --ioengine=libaio --rw=randread --bs=4k --numjobs=1 --size=1G --runtime=60 --time_based

# 测试顺序写性能
fio --name=seqwrite --ioengine=libaio --rw=write --bs=128k --numjobs=1 --size=1G

# ③ 混合读写（真实场景）
fio --name=test --ioengine=libaio --rw=randrw --rwmixread=70 --bs=4k --numjobs=4 --size=1G --runtime=120
    
# 使用配置文件测试
fio jobfile.fio
```
##### 输出内容解释
- 基本测试信息
```bash
randread: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1
fio-3.36
```
随机读取，块i大小4kb,io引擎libaio(异步io)，队列深度是1,fio版本3.36
- 测试实时进度
```bash
Starting 1 process
randread: Laying out IO file (1 file / 1024MiB)
Jobs: 1 (f=1): [r(1)][100.0%][r=69.3MiB/s][r=17.8k IOPS][eta 00m:00s]
```
一个进程，一个文件，大小1GB，实时速度69.3MB/s，17.8k IOPS，100% 完成
- 总体性能
```bash
randread: (groupid=0, jobs=1): err= 0: pid=7580: Wed Dec 31 09:38:53 2025
read: IOPS=17.8k, BW=69.7MiB/s (73.1MB/s)(4180MiB/60001msec)
```
- 延迟分析
```bash
slat (usec): min=19, max=1304, avg=55.03, stdev= 5.20
clat (nsec): min=461, max=157822, avg=527.72, stdev=205.25
lat (usec): min=19, max=1305, avg=55.56, stdev= 5.21
```
系统提交延迟，设备完成延迟，总延迟
- 延迟百分位（看一致性）
```bash
    clat percentiles (nsec):
|  1.00th=[  510],  5.00th=[  510], 10.00th=[  510], 20.00th=[  516],
| 30.00th=[  524], 40.00th=[  524], 50.00th=[  524], 60.00th=[  524],
| 70.00th=[  524], 80.00th=[  524], 90.00th=[  532], 95.00th=[  532],
| 99.00th=[  660], 99.50th=[  780], 99.90th=[ 1304], 99.95th=[ 2256],
| 99.99th=[ 4896]
```
- 带宽与IOPS波动
```bash
bw (  KiB/s): min=58048, max=77056, per=100.00%, avg=71360.27, stdev=2779.86, samples=119
iops: min=14512, max=19264, avg=17840.07, stdev=694.97, samples=119
```
- 延迟分布值方图
```bash
lat (nsec)   : 500=0.04%, 750=99.17%, 1000=0.59%
lat (usec)   : 2=0.14%, 4=0.04%, 10=0.01%, 20=0.01%, 50=0.01%
lat (usec)   : 250=0.01%
```
- CPU使用情况
```bash
cpu : usr=1.16%, sys=12.21%, ctx=1070437, majf=0, minf=12
```
- IO队列深度统计
```bash
IO depths: 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
submit: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
complete: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
```
IO深度： 队列深度100%的时间都是1,严重限制性能
submit/complete模式  4=100%,每次批量提交4个请求
- 运行状态总结
```bash
Run status group 0 (all jobs):
READ: bw=69.7MiB/s (73.1MB/s), 69.7MiB/s-69.7MiB/s (73.1MB/s-73.1MB/s), io=4180MiB (4383MB), run=60001-60001msec 
```
- 磁盘统计数据
```bash
Disk stats (read/write):
  nvme0n1: ios=1069966/635, sectors=8561056/47696, merge=0/321, ticks=52791/83, in_queue=52912, util=90.63%
```
读操作1069966次
写操作635次
磁盘利用率90.63%
队列中的时间52912ms
##### 其他注意
测试多线程高并发能力
```bash
# 每个线程测试小数据，主要测并发能力
fio --name=test --ioengine=libaio --rw=randread --bs=4k \
    --numjobs=64 --size=100M --runtime=60 --time_based
```
- numjobs与iodepth的区别
numjobs: 启动多个测试线程
iodepth: 每个线程的请求队列深度
```bash
# 场景：模拟数据库高并发
fio --name=db --rw=randread --bs=4k \
    --numjobs=16 \     # 16个应用在访问
    --iodepth=32 \     # 每个应用有32个并发请求
    --size=10G \       # 总测试数据10GB
    --runtime=120      # 测试2分钟
```
--direct=1 直接绕过缓存PageCache

或者直接清除缓存:
```bash
echo 3 > /proc/sys/vm/drop_caches 
sync                           
```
Q：fio的util=90.63%是好事还是坏事？
A：**测试时高util是正常的**，说明磁盘在全力工作。生产环境长期>80%才需要担心。
#### ioping
测试磁盘延迟
## 设备与文件系统侦察（磁盘健康吗？）
#### lsblk - 块设备侦察
```bash
# 查看所有块设备
lsblk

# 带详细信息和文件系统类型
lsblk -f

# 以树状显示（更清晰）
lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINT
```
loop： 把一个普通文件“伪装”成一块磁盘（块设备），从而可以像操作物理硬盘一样对它进行分区、格式化、挂载等操作。
   
   
#### fdisk -分区管理侦察
```bash
# 查看分区表
sudo fdisk -l
```

#### smartctl - 磁盘健康侦察
查看磁盘的S.M.A.R.T.（自我监测）健康状态，预测磁盘故障。
```bash
# 查看详细信息
sudo smartctl -a /dev/sda
```