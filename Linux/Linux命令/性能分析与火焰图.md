## 火焰图是什么
简单说，火焰图是一种**可视化性能剖析数据**的方法，它：
- **X轴**：采样数量（时间比例），**越宽表示占用CPU越多**
- **Y轴**：调用栈深度，**从上到下是调用关系**
- **颜色**：通常随机分配，用于区分不同函数

## perf
- 采样
```bash
sudo perf record -F 99 -a -g  -- sleep 30
```
-F 每秒99次 
-a 全部CPU
-g 记录调用栈（生成火焰图必备）
sleep 30 采样30s

- 查看文本报告
```bash
sudo perf report --stdio | head -50
```

- 对特定进程采样
```bash
# 先找出进程PID
pgrep -f your_program_name
# 假设PID是1234
sudo perf record -F 99 -p 1234 -g -- sleep 30
```

## strace 系统调用跟踪器
```bash
# 跟踪一个命令的所有系统调用
strace -c ls /tmp 2>&1 | tail -20

# 跟踪特定类型的系统调用（如文件相关）
strace -e trace=file,open,close,read,write your_program

# 跟踪已运行进程
sudo strace -p 1234

# 看每条调用耗时
strace -T 程序名称
```
**关键输出**：
- `% time`：在该系统调用上花费的时间百分比
- `calls`：调用次数
- **如果 `open`/`read`/`write` 调用过多或耗时太长，可能是磁盘I/O瓶颈**


- 实例
```bash
howardhe@ASUS-HE:~/Project/Code$ strace -c ./main 2>&1
hello,world% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 25.00    0.000014           4         3           mprotect
 16.07    0.000009           1         8           mmap
 16.07    0.000009           9         1           munmap
  8.93    0.000005           5         1           write
  7.14    0.000004           4         1           arch_prctl
  7.14    0.000004           4         1           set_tid_address
  7.14    0.000004           4         1           set_robust_list
  7.14    0.000004           4         1           rseq
  5.36    0.000003           3         1           prlimit64
  0.00    0.000000           0         1           read
  0.00    0.000000           0         2           close
  0.00    0.000000           0         2           fstat
  0.00    0.000000           0         1           brk
  0.00    0.000000           0         2           pread64
  0.00    0.000000           0         1         1 access
  0.00    0.000000           0         1           execve
  0.00    0.000000           0        10         8 openat
  0.00    0.000000           0         4         3 newfstatat
------ ----------- ----------- --------- --------- ----------------
100.00    0.000056           1        42        12 total

```

## 绘制火焰图
```bash
# 1. 提取perf数据为可读格式
sudo perf script -i data文件 > out.perf

# 2. 折叠调用栈（关键步骤）
./stackcollapse-perf.pl out.perf > out.folded

# 3. 生成SVG火焰图
./flamegraph.pl out.folded > flamegraph.svg
```
#### 高级特性
1. 内存火焰图，分析内存分配热点
2. 差量火焰图，对比前后优化
